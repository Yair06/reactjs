name: Deploy to EC2 with Docker

on:
  push:
    branches:
      - dev  # Déclenche le workflow uniquement sur les commits de la branche 'dev'

jobs:
  deploy:
    runs-on: ubuntu-latest  # Utilisation de l'image Ubuntu pour exécuter les étapes

    steps:
      # Checkout du code source depuis le repository
      - name: Checkout code
        uses: actions/checkout@v2

      # Mettre à jour les paquets
      - name: Update packages
        run: sudo apt-get update -y && sudo apt-get upgrade -y

      # Installer Docker et Docker Compose
      - name: Install Docker and Docker Compose
        run: |
          # Installer Docker
          sudo apt-get install -y apt-transport-https ca-certificates curl software-properties-common
          curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh
          sudo usermod -aG docker $USER

          # Installer Docker Compose
          sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose

      # Ajouter la clé privée SSH encodée pour permettre l'accès à EC2
      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | base64 -d > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      # Ajouter GitHub à known_hosts pour éviter les avertissements de sécurité lors de la connexion SSH
      - name: Add GitHub to known_hosts
        run: ssh-keyscan github.com >> ~/.ssh/known_hosts

      # Déployer sur EC2 via SSH
      - name: Deploy to EC2 with Docker
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            # Vérifier si Docker et Docker Compose sont installés
            docker --version
            docker-compose --version

            # Aller dans le répertoire du projet
            cd ${{ secrets.WORK_DIR }}

            # Puller le dernier code
            git pull origin main

            # Arrêter et supprimer le conteneur Docker si déjà en cours
            docker-compose down
            docker system prune -f

            # Construire l'application et démarrer le conteneur Docker
            docker-compose up --build -d

            # Vérifier si le conteneur fonctionne
            docker ps

            # Pour tester que l'application fonctionne
            curl localhost:5000
          EOF
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          WORK_DIR: ${{ secrets.WORK_DIR }}

      # Nettoyage du répertoire .ssh pour la sécurité
      - name: Clean up SSH
        run: rm -rf ~/.ssh
